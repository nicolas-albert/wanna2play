services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      NODE_ENV: production
      PORT: "3000"
      SQLITE_PATH: /data/wanna2play.sqlite
      QDRANT_URL: http://qdrant:6333
      QDRANT_COLLECTION: wanna2play_games
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-}
      OLLAMA_EMBED_MODEL: ${OLLAMA_EMBED_MODEL:-nomic-embed-text}
    extra_hosts:
      - host.docker.internal:host-gateway
    ports:
      - "3210:3000"
    volumes:
      - sqlite-data:/data
    depends_on:
      - qdrant

  steam-import:
    image: node:20-bookworm-slim
    working_dir: /work
    command: ["node", "scripts/steam-import.mjs"]
    environment:
      WANNA2PLAY_APP_URL: http://app:3000
      STEAM_API_KEY: ${STEAM_API_KEY:-}
      STEAM_ID: ${STEAM_ID:-}
      STEAM_PROFILE: ${STEAM_PROFILE:-}
      STEAM_LOCAL_ROOT: ${STEAM_LOCAL_ROOT:-}
      IMPORT_CONCURRENCY: ${IMPORT_CONCURRENCY:-4}
    volumes:
      - ./:/work:ro
    depends_on:
      - app
    profiles:
      - tools

  steam-local-import:
    image: node:20-bookworm-slim
    working_dir: /work
    command: ["node", "scripts/steam-import.mjs"]
    environment:
      WANNA2PLAY_APP_URL: http://app:3000
      STEAM_LOCAL_ROOT: ${STEAM_LOCAL_ROOT:?Set STEAM_LOCAL_ROOT to your Steam folder}
      IMPORT_CONCURRENCY: ${IMPORT_CONCURRENCY:-4}
    volumes:
      - ./:/work:ro
      - ${STEAM_LOCAL_ROOT:?Set STEAM_LOCAL_ROOT to your Steam folder}:${STEAM_LOCAL_ROOT}:ro
    depends_on:
      - app
    profiles:
      - tools

  qdrant:
    image: qdrant/qdrant:v1.15.4
    volumes:
      - qdrant-data:/qdrant/storage

volumes:
  qdrant-data:
  sqlite-data:
